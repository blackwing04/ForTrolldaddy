<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>模擬 Twitch 上傳驗證 — GZIP + Base91 測試</title>
<script src="./fflate.js"></script>
<style>
  body { background:#0b0b0b; color:#eee; font-family:"Microsoft JhengHei",sans-serif; padding:20px; }
  textarea { width:100%; height:220px; font-family:monospace; background:#111; color:#eee; border:1px solid #333; padding:8px; }
  button { margin:8px 0; padding:8px 14px; font-size:14px; }
  .box { background:#111; padding:12px; border-radius:8px; border:1px solid #333; margin:10px 0; white-space:pre-wrap; word-break:break-all; }
</style>
</head>
<body>
  <h1>模擬 Twitch Configuration 上傳（GZIP + Base91）</h1>
  <p>貼入 JSON → Key Minify → GZIP 壓縮 → Base91 編碼 → 檢查是否通過 5KB 限制並可還原。</p>

  <textarea id="jsonInput" placeholder="請貼上 JSON…">
{
  "name": "測試合集",
  "roles": [
    {"name": "村民", "ability": "投票", "team": "善"},
    {"name": "狼人", "ability": "殺人", "team": "惡"}
  ],
  "meta": {"author":"Joe", "date":"2025-10-26"}
}
  </textarea>
  <br>
  <button id="runBtn">🔧 壓縮並模擬上傳</button>

  <h3>結果</h3>
  <div id="output" class="box">尚未執行</div>

<script>
// ------- Base91 (純字串安全) -------
const base91Table =
  "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789" +
  "!#$%&()*+,./:;<=>?@[]^_`{|}~\"";
const base91Dict = Object.fromEntries([...base91Table].map((c, i) => [c, i]));
function base91Encode(bytes) {
  let b = 0, n = 0, out = "";
  for (let i = 0; i < bytes.length; i++) {
    b |= bytes[i] << n; n += 8;
    if (n > 13) {
      let v = b & 8191;
      if (v > 88) { b >>= 13; n -= 13; }
      else { v = b & 16383; b >>= 14; n -= 14; }
      out += base91Table[v % 91] + base91Table[Math.floor(v / 91)];
    }
  }
  if (n) out += base91Table[b % 91] + (n > 7 || b > 90 ? base91Table[Math.floor(b / 91)] : "");
  return out;
}
function base91Decode(str) {
  let b = 0, n = 0, out = [], v = -1;
  for (let i = 0; i < str.length; i++) {
    const code = base91Dict[str[i]];
    if (code === undefined) continue;
    if (v < 0) v = code;
    else {
      v += code * 91;
      b |= v << n; n += (v & 8191) > 88 ? 13 : 14;
      do { out.push(b & 255); b >>= 8; n -= 8; } while (n > 7);
      v = -1;
    }
  }
  if (v + 1) out.push((b | (v << n)) & 255);
  return new Uint8Array(out);
}

// ------- Key Minify（可逆） -------
function minifyAndShortenKeys(obj) {
  const keyMap = new Map(); let idx = 0;
  const shortKey = k => keyMap.has(k) ? keyMap.get(k) : (keyMap.set(k, `k${idx++}`), keyMap.get(k));
  const walk = x => Array.isArray(x) ? x.map(walk)
    : (x && typeof x === "object") ? Object.fromEntries(Object.entries(x).map(([k,v]) => [shortKey(k), walk(v)]))
    : x;
  return { json: JSON.stringify(walk(obj)), keyMap };
}
function restoreKeys(obj, keyMap) {
  const rev = new Map([...keyMap.entries()].map(([k,v]) => [v,k]));
  const walk = x => Array.isArray(x) ? x.map(walk)
    : (x && typeof x === "object") ? Object.fromEntries(Object.entries(x).map(([k,v]) => [rev.get(k) || k, walk(v)]))
    : x;
  return walk(obj);
}

// ------- 模擬 Twitch 檢查（UTF-8 長度 / 控制字元 / 5KB） -------
function simulateTwitchChecks(str) {
  const enc = new TextEncoder(); const bytes = enc.encode(str);
  const segLimit = 5000;
  // 禁止 0-31 控制字元（允許 9,10,13）
  const bad = [];
  for (let i=0;i<bytes.length;i++){
    const c = bytes[i];
    if (c >= 0 && c <= 31 && c !== 9 && c !== 10 && c !== 13) bad.push({i,c});
  }
  return { lengthBytes: bytes.length, within: bytes.length <= segLimit, bad, segLimit };
}

// ------- 壓縮（GZIP）+ 編碼（Base91） -------
function gzipToBase91(str) {
  const { gzipSync, strToU8 } = fflate;
  const gz = gzipSync(strToU8(str));          // Uint8Array
  const enc = base91Encode(gz);               // 字串（比 Base64 更小）
  return { gzBytes: gz, encoded: enc };
}
function ungzipFromBase91(s) {
  const { gunzipSync, strFromU8 } = fflate;
  const u8 = base91Decode(s);
  return strFromU8(gunzipSync(u8));
}

// ------- 主流程 -------
document.getElementById("runBtn").addEventListener("click", () => {
  const raw = document.getElementById("jsonInput").value.trim();
  const out = document.getElementById("output");
  if (!raw) { out.textContent = "⚠️ 請先輸入 JSON"; return; }
  try {
    const obj = JSON.parse(raw);                            // 驗證合法 JSON
    const { json: minified, keyMap } = minifyAndShortenKeys(obj);

    const t0 = performance.now();
    const { gzBytes, encoded } = gzipToBase91(minified);    // GZIP → Base91
    const t1 = performance.now();

    const chk = simulateTwitchChecks(encoded);              // 模擬上傳檢查
    const restoredMin = ungzipFromBase91(encoded);          // 解回 minify 版本
    const restoredObj = restoreKeys(JSON.parse(restoredMin), keyMap);
    const ok = JSON.stringify(restoredObj) === JSON.stringify(obj);

    const enc = new TextEncoder();
    const origBytes = enc.encode(raw).length;
    const miniBytes = enc.encode(minified).length;
    const gzLen    = gzBytes.length;        // 二進位壓縮長度
    const b91Len   = encoded.length;        // 要上傳的字串長度（ASCII 1字元=1byte）

    out.textContent =
`原始大小：${origBytes} bytes
minify 後：${miniBytes} bytes
GZIP 二進位大小：${gzLen} bytes
Base91 字串長度（上傳長度）：${b91Len} bytes

Twitch 模擬檢查（上限 ${chk.segLimit} bytes）：
  • 是否在限制內：${chk.within ? "✅ 是" : "❌ 否"}
  • 控制字元數：${chk.bad.length}

還原驗證：${ok ? "✅ 正確還原" : "❌ 還原失敗"}
耗時：約 ${(t1 - t0).toFixed(2)} ms`;
  } catch (e) {
    out.textContent = "錯誤：輸入不是合法 JSON 或處理失敗。\n" + e.message;
  }
});
</script>
</body>
</html>
