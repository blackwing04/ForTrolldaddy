<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>Gzip + Key Mapping + Minify å£“ç¸®æ¸¬è©¦ (é›™å‘é‚„åŸ)</title>
  <style>
    body { background: #111; color: #eee; font-family: Consolas, monospace; padding: 20px; }
    h1 { color: #0ff; }
    textarea { width: 100%; height: 200px; background: #222; color: #eee; border: 1px solid #444; padding: 8px; font-family: Consolas; }
    button { background: #0ff; color: #111; padding: 10px 20px; border: none; cursor: pointer; font-weight: bold; margin: 10px 0; }
    button:hover { background: #0cc; }
    .box { background: #222; border: 1px solid #444; padding: 10px; margin: 10px 0; white-space: pre-wrap; word-break: break-all; }
  </style>
</head>
<body>
  <h1>ğŸ”¥ Gzip + Key Mapping å£“ç¸®æ¸¬è©¦ï¼ˆå¯é‚„åŸåŸå§‹ keyï¼‰</h1>

  <p>è«‹è²¼ä¸Šä½ è¦æ¸¬è©¦çš„ JSONï¼š</p>
  <textarea id="jsonInput" placeholder="è²¼ä¸Š JSON..."></textarea><br>
  <button id="compressBtn">ğŸš€ é–‹å§‹å£“ç¸®æ¸¬è©¦</button>

  <div id="info" class="box">ç­‰å¾…è¼¸å…¥ä¸­...</div>
  <h3>å£“ç¸®å¾Œ Base64</h3>
  <div id="comp" class="box"></div>
  <h3>è§£å£“å¾Œ JSON</h3>
  <div id="restored" class="box"></div>

  <script>
    const el = id => document.getElementById(id);

    // âœ… Key æ˜ å°„è¡¨ï¼ˆé›™å‘ï¼‰
    const keyMap = {
      name: 'n', ability: 'a', team: 't', description: 'd',
      image: 'i', type: 'y', category: 'c', alignment: 'm',
      script: 's', role: 'r', id: 'x'
    };
    const reverseMap = Object.fromEntries(Object.entries(keyMap).map(([k,v]) => [v,k]));

    // âœ… çŸ­ key è½‰æ›
    function remapKeys(obj) {
      if (Array.isArray(obj)) return obj.map(remapKeys);
      if (typeof obj === 'object' && obj) {
        const out = {};
        for (const [k, v] of Object.entries(obj))
          out[keyMap[k] || k] = remapKeys(v);
        return out;
      }
      return obj;
    }

    // âœ… å¾©åŸ key åç¨±
    function restoreKeys(obj) {
      if (Array.isArray(obj)) return obj.map(restoreKeys);
      if (typeof obj === 'object' && obj) {
        const out = {};
        for (const [k, v] of Object.entries(obj))
          out[reverseMap[k] || k] = restoreKeys(v);
        return out;
      }
      return obj;
    }

    // âœ… Gzip å£“ç¸®
    async function gzipCompress(str) {
      const cs = new CompressionStream("deflate");
      const writer = cs.writable.getWriter();
      writer.write(new TextEncoder().encode(str));
      writer.close();
      const compressed = await new Response(cs.readable).arrayBuffer();
      return btoa(String.fromCharCode(...new Uint8Array(compressed)));
    }

    // âœ… Gzip è§£å£“
    async function gzipDecompress(base64) {
      const bytes = Uint8Array.from(atob(base64), c => c.charCodeAt(0));
      const ds = new DecompressionStream("deflate");
      const writer = ds.writable.getWriter();
      writer.write(bytes);
      writer.close();
      const decompressed = await new Response(ds.readable).arrayBuffer();
      return new TextDecoder().decode(decompressed);
    }

    async function runCompressionTest() {
      const input = el("jsonInput").value.trim();
      if (!input) {
        el("info").textContent = "âš ï¸ è«‹å…ˆè¼¸å…¥ JSON å…§å®¹";
        return;
      }

      el("info").textContent = "ğŸ—œï¸ æ­£åœ¨å£“ç¸®ä¸­...";
      let jsonText = input;
      let originalParsed = null;
      try {
        originalParsed = JSON.parse(input);
        const remapped = remapKeys(originalParsed);
        jsonText = JSON.stringify(remapped);
      } catch (e) {
        console.warn("è¼¸å…¥ä¸æ˜¯åˆæ³• JSONï¼Œå°‡ä»¥ç´”æ–‡å­—å£“ç¸®");
      }

      try {
        const compressed = await gzipCompress(jsonText);
        const restored = await gzipDecompress(compressed);

        let restoredParsed, restoredFinal;
        try {
          restoredParsed = JSON.parse(restored);
          restoredFinal = JSON.stringify(restoreKeys(restoredParsed), null, 2);
        } catch (e) {
          restoredFinal = restored;
        }

        const encoder = new TextEncoder();
        const originalBytes = encoder.encode(JSON.stringify(originalParsed)).length;
        const compressedBytes = compressed.length;
        const ratio = ((compressedBytes / originalBytes) * 100).toFixed(1);
        const identical = JSON.stringify(originalParsed) === JSON.stringify(JSON.parse(restoredFinal));

        el("info").textContent =
          `åŸå§‹å¤§å°ï¼š${originalBytes} bytes\n` +
          `å£“ç¸®å¾Œå¤§å°ï¼š${compressedBytes} bytes\n` +
          `å£“ç¸®ç‡ï¼š${ratio}%\n` +
          `æ˜¯å¦æ­£ç¢ºé‚„åŸï¼š${identical ? "âœ… æ˜¯" : "âŒ å¦"}`;

        el("comp").textContent = compressed;
        el("restored").textContent = restoredFinal;
      } catch (err) {
        console.error("å£“ç¸®æˆ–è§£å£“å¤±æ•—ï¼š", err);
        el("info").textContent = "âŒ éŒ¯èª¤ï¼š" + err.message;
      }
    }

    el("compressBtn").addEventListener("click", runCompressionTest);
  </script>
</body>
</html>
