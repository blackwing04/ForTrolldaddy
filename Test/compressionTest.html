<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <title>æ¨¡æ“¬ Twitch ä¸Šå‚³é©—è­‰ â€” GZIP + Base91 æ¸¬è©¦</title>
    <script src="./fflate.js"></script>
    <script src="./compression.js"></script>
    <style>
        body {
            background: #0b0b0b;
            color: #eee;
            font-family: "Microsoft JhengHei",sans-serif;
            padding: 20px;
        }

        textarea {
            width: 100%;
            height: 220px;
            font-family: monospace;
            background: #111;
            color: #eee;
            border: 1px solid #333;
            padding: 8px;
        }

        button {
            margin: 8px 0;
            padding: 8px 14px;
            font-size: 14px;
        }

        .box {
            background: #111;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #333;
            margin: 10px 0;
            white-space: pre-wrap;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <h1>æ¨¡æ“¬ Twitch Configuration ä¸Šå‚³ï¼ˆGZIP + Base91ï¼‰</h1>
    <p>è²¼å…¥ JSON â†’ Key Minify â†’ GZIP å£“ç¸® â†’ Base91 ç·¨ç¢¼ â†’ æª¢æŸ¥æ˜¯å¦é€šé 5KB é™åˆ¶ä¸¦å¯é‚„åŸã€‚</p>

    <textarea id="jsonInput" placeholder="è«‹è²¼ä¸Š JSONâ€¦">
    </textarea>
    <br>
    <button id="runBtn">ğŸ”§ å£“ç¸®ä¸¦æ¨¡æ“¬ä¸Šå‚³</button>

    <h3>çµæœ</h3>
    <div id="output" class="box">å°šæœªåŸ·è¡Œ</div>
    <h3>è§£å£“å¾Œ JSON</h3>
    <textarea id="jsonOutput" disabled>
    </textarea>

    <script>
        // ------- æ¨¡æ“¬ Twitch æª¢æŸ¥ï¼ˆUTF-8 é•·åº¦ / æ§åˆ¶å­—å…ƒ / 5KBï¼‰ -------
        function simulateTwitchChecks(str) {
            const enc = new TextEncoder(); const bytes = enc.encode(str);
            const segLimit = 5000;
            // ç¦æ­¢ 0-31 æ§åˆ¶å­—å…ƒï¼ˆå…è¨± 9,10,13ï¼‰
            const bad = [];
            for (let i = 0; i < bytes.length; i++) {
                const c = bytes[i];
                if (c >= 0 && c <= 31 && c !== 9 && c !== 10 && c !== 13) bad.push({ i, c });
            }
            return { lengthBytes: bytes.length, within: bytes.length <= segLimit, bad, segLimit };
        }

        // ------- ä¸»æµç¨‹ -------
        document.getElementById("runBtn").addEventListener("click", () => {
            const raw = document.getElementById("jsonInput").value.trim();
            const out = document.getElementById("output");
            const restoredOut = document.getElementById("jsonOutput");

            if (!raw) { out.textContent = "âš ï¸ è«‹å…ˆè¼¸å…¥ JSON"; return; }
            try {
                const obj = JSON.parse(raw);                            // é©—è­‰åˆæ³• JSON
                const compress = window.CompressionHelper.compressToStorableString(JSON.stringify(obj));
                const encoded = compress.encodedString;
                const chk = simulateTwitchChecks(encoded);              // æ¨¡æ“¬ä¸Šå‚³æª¢æŸ¥
                const restoredObj = JSON.parse(window.CompressionHelper.decompressFromStorableString(encoded));
                const ok = JSON.stringify(restoredObj) === JSON.stringify(obj);
                out.textContent =
                    `åŸå§‹å¤§å°ï¼š${compress.originalLength} bytes
                       Base91 å­—ä¸²é•·åº¦ï¼ˆä¸Šå‚³é•·åº¦ï¼‰ï¼š${compress.compressedLength} bytes

                      Twitch æ¨¡æ“¬æª¢æŸ¥ï¼ˆä¸Šé™ ${chk.segLimit} bytesï¼‰ï¼š
                      â€¢ æ˜¯å¦åœ¨é™åˆ¶å…§ï¼š${chk.within ? "âœ… æ˜¯" : "âŒ å¦"}
                      â€¢ æ§åˆ¶å­—å…ƒæ•¸ï¼š${chk.bad.length}
                      â€¢ é‚„åŸé©—è­‰ï¼š${ok ? "âœ… æ­£ç¢ºé‚„åŸ" : "âŒ é‚„åŸå¤±æ•—"}`;
                restoredOut.value = JSON.stringify(restoredObj, null, 2);
            } catch (e) {
                out.textContent = "éŒ¯èª¤ï¼šè¼¸å…¥ä¸æ˜¯åˆæ³• JSON æˆ–è™•ç†å¤±æ•—ã€‚\n" + e.message;
            }
        });
    </script>
</body>
</html>
