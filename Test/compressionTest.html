<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <title>模擬 Twitch 上傳驗證 — GZIP + Base91 測試</title>
    <script src="./fflate.js"></script>
    <script src="./compression.js"></script>
    <style>
        body {
            background: #0b0b0b;
            color: #eee;
            font-family: "Microsoft JhengHei",sans-serif;
            padding: 20px;
        }

        textarea {
            width: 100%;
            height: 220px;
            font-family: monospace;
            background: #111;
            color: #eee;
            border: 1px solid #333;
            padding: 8px;
        }

        button {
            margin: 8px 0;
            padding: 8px 14px;
            font-size: 14px;
        }

        .box {
            background: #111;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #333;
            margin: 10px 0;
            white-space: pre-wrap;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <h1>模擬 Twitch Configuration 上傳（GZIP + Base91）</h1>
    <p>貼入 JSON → Key Minify → GZIP 壓縮 → Base91 編碼 → 檢查是否通過 5KB 限制並可還原。</p>

    <textarea id="jsonInput" placeholder="請貼上 JSON…">
    </textarea>
    <br>
    <button id="runBtn">🔧 壓縮並模擬上傳</button>

    <h3>結果</h3>
    <div id="output" class="box">尚未執行</div>
    <h3>解壓後 JSON</h3>
    <textarea id="jsonOutput" disabled>
    </textarea>

    <script>
        // ------- 模擬 Twitch 檢查（UTF-8 長度 / 控制字元 / 5KB） -------
        function simulateTwitchChecks(str) {
            const enc = new TextEncoder(); const bytes = enc.encode(str);
            const segLimit = 5000;
            // 禁止 0-31 控制字元（允許 9,10,13）
            const bad = [];
            for (let i = 0; i < bytes.length; i++) {
                const c = bytes[i];
                if (c >= 0 && c <= 31 && c !== 9 && c !== 10 && c !== 13) bad.push({ i, c });
            }
            return { lengthBytes: bytes.length, within: bytes.length <= segLimit, bad, segLimit };
        }

        // ------- 主流程 -------
        document.getElementById("runBtn").addEventListener("click", () => {
            const raw = document.getElementById("jsonInput").value.trim();
            const out = document.getElementById("output");
            const restoredOut = document.getElementById("jsonOutput");

            if (!raw) { out.textContent = "⚠️ 請先輸入 JSON"; return; }
            try {
                const obj = JSON.parse(raw);                            // 驗證合法 JSON
                const compress = window.CompressionHelper.compressToStorableString(JSON.stringify(obj));
                const encoded = compress.encodedString;
                const chk = simulateTwitchChecks(encoded);              // 模擬上傳檢查
                const restoredObj = JSON.parse(window.CompressionHelper.decompressFromStorableString(encoded));
                const ok = JSON.stringify(restoredObj) === JSON.stringify(obj);
                out.textContent =
                    `原始大小：${compress.originalLength} bytes
                       Base91 字串長度（上傳長度）：${compress.compressedLength} bytes

                      Twitch 模擬檢查（上限 ${chk.segLimit} bytes）：
                      • 是否在限制內：${chk.within ? "✅ 是" : "❌ 否"}
                      • 控制字元數：${chk.bad.length}
                      • 還原驗證：${ok ? "✅ 正確還原" : "❌ 還原失敗"}`;
                restoredOut.value = JSON.stringify(restoredObj, null, 2);
            } catch (e) {
                out.textContent = "錯誤：輸入不是合法 JSON 或處理失敗。\n" + e.message;
            }
        });
    </script>
</body>
</html>
