
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>BOTC Admin</title>
    <script src="https://extension-files.twitch.tv/helper/v1/twitch-ext.min.js"></script>
    <script src="fflate.js"></script>
    <script src="compression.js"></script>
    <style>
        body {
            background: #111;
            color: white;
            font-family: "Microsoft JhengHei", sans-serif;
            padding: 20px;
        }

        label, select, textarea, button {
            display: block;
            margin: 10px 0;
            width: 100%;
        }

        textarea {
            height: 200px;
            font-family: monospace;
        }

        #customJsonBlock {
            display: none;
        }

        #statusMessage {
            margin-top: 10px;
            color: #0f0;
        }
    </style>
</head>
<body>
    <h1>è¨­å®š BOTC Overlay æ“´å……åŠŸèƒ½</h1>
    <label for="scriptList">é¸æ“‡åŠ‡æœ¬ï¼š</label>
    <select id="scriptList"></select>

    <div id="customJsonBlock">
        <label for="customJson">è‡ªè¨‚è§’è‰² JSONï¼š</label>
        <textarea id="customJson" placeholder="è²¼ä¸Šç¬¦åˆ Blood on the Clocktower æ ¼å¼çš„è§’è‰² JSON æ¸…å–®"></textarea>
    </div>

    <button id="saveButton">å„²å­˜è¨­å®š</button>
    <div id="statusMessage"></div>

    <script>
        const scriptListEl = document.getElementById('scriptList');
        const customJsonBlock = document.getElementById('customJsonBlock');
        const customJsonEl = document.getElementById('customJson');
        const saveButton = document.getElementById('saveButton');
        const statusMessage = document.getElementById('statusMessage');

        const COMPRESSION_MODE = window.CompressionHelper?.COMPRESSION_MODE || 'gzip/base64';
        const MAX_TWITCH_LIMIT = 5000; // Twitch å–®æ®µä¸Šé™ï¼ˆbytesï¼‰

        // åŸºæœ¬å·¥å…· ----------------------------------------------------------------
        function computeScriptHash(text) {
            let hash = 0;
            if (!text) return '0';
            for (let i = 0; i < text.length; i++) hash = (hash * 31 + text.charCodeAt(i)) >>> 0;
            return hash.toString(16);
        }

        async function compressCustomJson(normalizedJson) {
            const helper = window.CompressionHelper;
            if (!helper?.compressToBase64) throw new Error('æ‰¾ä¸åˆ° CompressionHelper');
            return await helper.compressToBase64(normalizedJson);
        }

        async function decompressBase64(base64, mode = COMPRESSION_MODE) {
            const helper = window.CompressionHelper;
            if (!helper?.decompressFromBase64) throw new Error('æ‰¾ä¸åˆ°è§£å£“å·¥å…·');
            return await helper.decompressFromBase64(base64, mode);
        }

        async function applyConfig(config) {
            if (!config || typeof config !== 'object') return;
            scriptListEl.value = config.selectedScript || '';
            customJsonBlock.style.display = scriptListEl.value === '__custom__' ? 'block' : 'none';

            if (config.selectedScript === '__custom__') {
                try {
                    let jsonText = '';
                    if (config.hasGlobalPart) {
                        // è‹¥æœ‰åˆ†å‰² â†’ å˜—è©¦åˆä½µ global æ®µ
                        const globalStr = window.Twitch.ext.configuration.global?.content;
                        const globalData = JSON.parse(globalStr || '{}');
                        const mergedBase64 = (config.compressedBase64 || '') + (globalData.compressedBase64 || '');
                        jsonText = await decompressBase64(mergedBase64, config.compression);
                    } else if (config.compressedBase64) {
                        jsonText = await decompressBase64(config.compressedBase64, config.compression);
                    } else if (config.customJson) {
                        jsonText = config.customJson;
                    }
                    customJsonEl.value = jsonText;
                } catch (err) {
                    console.warn('âš ï¸ è§£å£“ç¸®å¤±æ•—:', err);
                    customJsonEl.value = '';
                }
            } else {
                customJsonEl.value = '';
            }
        }

        // -------------------------------------------------------------------------

        fetch('Allscript/scripts.json')
            .then(res => res.json())
            .then(scripts => {
                scriptListEl.innerHTML =
                    `<option value="">-- è«‹é¸æ“‡åŠ‡æœ¬ --</option>` +
                    scripts.map(f => `<option value="${f}">${f}</option>`).join('') +
                    `<option value="__custom__">è‡ªè¨‚åŠ‡æœ¬</option>`;
            })
            .catch(() => (statusMessage.textContent = 'âŒ ç„¡æ³•è¼‰å…¥åŠ‡æœ¬æ¸…å–®'));

        scriptListEl.addEventListener('change', () => {
            customJsonBlock.style.display = scriptListEl.value === '__custom__' ? 'block' : 'none';
        });

        // å„²å­˜ --------------------------------------------------------------------
        saveButton.addEventListener('click', async () => {
            const selectedScript = scriptListEl.value;
            if (!selectedScript) {
                statusMessage.textContent = 'âŒ è«‹å…ˆé¸æ“‡åŠ‡æœ¬';
                return;
            }
            if (!window.Twitch?.ext?.configuration) {
                statusMessage.textContent = 'âŒ ç„¡æ³•å­˜å– Twitch Extension API';
                return;
            }

            const timestamp = Date.now();
            let payload = {};
            const baseInfo = {
                selectedScript,
                _timestamp: timestamp,
                scriptVersion: timestamp,
            };

            // ğŸ§© è‡ªè¨‚åŠ‡æœ¬é‚è¼¯ -------------------------------------------------------
            if (selectedScript === '__custom__') {
                const rawJson = customJsonEl.value.trim();
                if (!rawJson) return (statusMessage.textContent = 'âŒ è«‹è²¼ä¸Šè‡ªè¨‚åŠ‡æœ¬å…§å®¹');
                let normalized;
                try {
                    normalized = JSON.stringify(JSON.parse(rawJson));
                } catch (err) {
                    statusMessage.textContent = `âŒ JSON æ ¼å¼éŒ¯èª¤ï¼š${err.message}`;
                    return;
                }

                statusMessage.textContent = 'ğŸ—œï¸ æ­£åœ¨å£“ç¸®...';
                saveButton.disabled = true;

                try {
                    const compressed = await compressCustomJson(normalized);
                    const base64Data = compressed.base64;
                    const overLimit = base64Data.length > MAX_TWITCH_LIMIT;

                    payload = {
                        ...baseInfo,
                        scriptHash: computeScriptHash(normalized),
                        compression: compressed.mode || COMPRESSION_MODE,
                        compressedBase64: overLimit ? base64Data.slice(0, MAX_TWITCH_LIMIT) : base64Data,
                        hasGlobalPart: overLimit,
                    };

                    // ä¸»æ®µä¸Šå‚³ ----------------------------------------------------------
                    const payloadStr = JSON.stringify(payload);
                    window.Twitch.ext.configuration.set('broadcaster', '1', payloadStr);

                    // åˆ†æ®µä¸Šå‚³ ----------------------------------------------------------
                    if (overLimit) {
                        try {
                            const globalStr = JSON.stringify({ compressedBase64: base64Data.slice(MAX_TWITCH_LIMIT) });
                            await new Promise(r => setTimeout(r, 300));
                            window.Twitch.ext.configuration.set('global', '1', globalStr);
                            console.log('[Upload] broadcaster + global åˆ†æ®µä¸Šå‚³å®Œæˆ');
                        } catch (err) {
                            console.warn('[Upload] ä¸Šå‚³ global æ®µå¤±æ•—:', err);
                            statusMessage.textContent = 'âš ï¸ åŠ‡æœ¬è¶…é 5KBï¼Œä¸”ç„¡æ¬Šé™ä¸Šå‚³ç¬¬äºŒæ®µï¼Œè«‹ç¸®å°åŠ‡æœ¬å…§å®¹ã€‚';
                        }
                    }

                    // é€šçŸ¥ overlay ------------------------------------------------------
                    if (window.Twitch.ext.send) {
                        window.Twitch.ext.send('broadcast', 'text/plain', 'CONFIG_UPDATED');
                        console.log('[Broadcast] CONFIG_UPDATED å·²ç™¼é€');
                    }

                    statusMessage.textContent = 'âœ… è¨­å®šå·²å„²å­˜ä¸¦åŒæ­¥åˆ° Twitchï¼';
                } catch (err) {
                    console.error('å£“ç¸®æˆ–ä¸Šå‚³éŒ¯èª¤:', err);
                    statusMessage.textContent = 'âŒ å„²å­˜å¤±æ•—';
                } finally {
                    saveButton.disabled = false;
                }
                return;
            }

            // ğŸ§© å…§å»ºåŠ‡æœ¬ -----------------------------------------------------------
            payload = { ...baseInfo };
            const payloadStr = JSON.stringify(payload);
            try {
                window.Twitch.ext.configuration.set('broadcaster', '1', payloadStr);
                if (window.Twitch.ext.send)
                    window.Twitch.ext.send('broadcast', 'text/plain', 'CONFIG_UPDATED');
                statusMessage.textContent = 'âœ… å·²å„²å­˜è¨­å®š';
            } catch (err) {
                console.error('Twitch è¨­å®šå„²å­˜å¤±æ•—:', err);
                statusMessage.textContent = 'âŒ å„²å­˜å¤±æ•—';
            }
        });

        // è¨‚é–±è®Šæ›´ ----------------------------------------------------------------
        if (window.Twitch?.ext) {
            window.Twitch.ext.configuration.onChanged(async () => {
                try {
                    const configStr = window.Twitch.ext.configuration.broadcaster?.content;
                    const cfg = JSON.parse(configStr || '{}');
                    await applyConfig(cfg);
                } catch (err) {
                    console.warn('è§£æ Twitch è¨­å®šå¤±æ•—:', err);
                }
            });
        }
    </script>

</body>
</html>
